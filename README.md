# Telegram to Supabase Importer (Unified)

–ü—Ä–æ–µ–∫—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞, –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –∏–∑ Telegram-–∫–∞–Ω–∞–ª–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **Google Gemini 2.0 Flash Lite** (AI) –∏ Supabase.

## üöÄ Deployment (VPS)
–ü—Ä–æ–µ–∫—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ `server.reloto.ru` (148.230.107.136).

### –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ
- **–ü—É—Ç—å:** `/root/scripts/bao_tg_importer`
- **–û–∫—Ä—É–∂–µ–Ω–∏–µ:** `venv` (Python 3.12)
- **–õ–æ–≥–∏ –∫—Ä–æ–Ω–∞:** `/root/scripts/bao_tg_importer/logs/cron.log`
- **–õ–æ–≥ –∏–º–ø–æ—Ä—Ç–∞:** `/root/scripts/bao_tg_importer/log.md` (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø—É–ª–ª–µ)

### –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ (Cron)
–°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ **–∫–∞–∂–¥—ã–π —á–∞—Å —Å 07:00 –¥–æ 23:00** (–ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ë—É—ç–Ω–æ—Å-–ê–π—Ä–µ—Å–∞ / GMT-3).
- –í UTC (–≤—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞) —ç—Ç–æ: `10:00 - 02:00`.

### üîÑ –ö–∞–∫ –æ–±–Ω–æ–≤–ª—è—Ç—å (Deploy)
–î–ª—è –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (–≤ –∫–æ–¥ –∏–ª–∏ –ø—Ä–æ–º–ø—Ç—ã):
1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã –ª–æ–∫–∞–ª—å–Ω–æ.
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:
   ```bash
   ./deploy.sh (–≤ CLI —Å–∫–∞–∂–∏ "–¥–µ–ø–ª–æ–π")
   ```

**–°—Ö–µ–º–∞ –¥–µ–ø–ª–æ—è:**
1. **Local ‚Üí GitHub:** –°–∫—Ä–∏–ø—Ç –¥–µ–ª–∞–µ—Ç –∫–æ–º–º–∏—Ç –∏ –ø—É—à (`git push`) –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.
2. **SSH Trigger:** –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ VPS –∏ –¥–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.
3. **VPS ‚Üí GitHub:** –°–µ—Ä–≤–µ—Ä —Å–∫–∞—á–∏–≤–∞–µ—Ç —Å–≤–µ–∂–∏–π –∫–æ–¥ (`git fetch && git reset --hard origin/master`) –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (`pip install`).

### üîî –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –û–ø–æ–≤–µ—â–µ–Ω–∏—è
–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å–±–æ—è—Ö —á–µ—Ä–µ–∑ Telegram.
- **–ú–µ—Ö–∞–Ω–∏–∑–º:** Wrapper-—Å–∫—Ä–∏–ø—Ç `run_cron_importer.sh` —Å–ª–µ–¥–∏—Ç –∑–∞ –∫–æ–¥–æ–º –≤—ã—Ö–æ–¥–∞ Python-—Å–∫—Ä–∏–ø—Ç–∞.
- **–¢—Ä–∏–≥–≥–µ—Ä:** –ï—Å–ª–∏ –∏–º–ø–æ—Ä—Ç–µ—Ä –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π (exit code ‚â† 0).
- **–î–µ–π—Å—Ç–≤–∏–µ:** –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞ **@baoShopTest_bot**.
- **–ü–æ–ª—É—á–∞—Ç–µ–ª—å:** Admin (ID: 159194550).
- **–õ–æ–≥–∏:** –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ `/root/scripts/bao_tg_importer/logs/cron.log`.

---

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
1. [–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏](#–æ—Å–Ω–æ–≤–Ω—ã–µ-–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
2. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
3. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–ø—Ä–æ–º–ø—Ç–æ–≤)
4. [–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã](#–ª–æ–≥–∏–∫–∞-—Ä–∞–±–æ—Ç—ã)
5. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–Ω–∞–ª–æ–≤](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–∫–∞–Ω–∞–ª–æ–≤-channel_sync_state)

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- **Unified Prompt:** –í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è –ò–ò (`!–ü—Ä–æ–º—Ç—ã/unified_ollama_prompt.md`).
- **Google Gemini:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Gemini –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞.
- **Multi-Event Support:** –ï—Å–ª–∏ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ Telegram —É–∫–∞–∑–∞–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–∞—Ç (–¥–æ 3-—Ö), —Å–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞—Å—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–±—ã—Ç–∏—è.
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ:** –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –ø–æ—Å—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ Supabase Storage (–±–∞–∫–µ—Ç `events`).
- **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:** –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è, –æ–ø–∏—Å–∞–Ω–∏—è, –¥–∞—Ç—ã, –≤—Ä–µ–º–µ–Ω–∏, –º–µ—Å—Ç–∞, —Ü–µ–Ω—ã –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ channel_id:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `channel_id` –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω, –Ω–∞ –æ—Å–Ω–æ–≤–µ `channel_name`.
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–æ–ø–∏–∫–æ–≤:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–æ–ø–∏–∫–æ–≤ (–≤–µ—Ç–≤–µ–π –æ–±—Å—É–∂–¥–µ–Ω–∏–π) –≤ –∫–∞–Ω–∞–ª–∞—Ö-—Ñ–æ—Ä—É–º–∞—Ö.
- **–î–µ–¥–∏–ø–ª–∏–∫–∞—Ü–∏—è:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å–æ–±—ã—Ç–∏–π –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
- `scripts/unified_importer.py` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –∏–º–ø–æ—Ä—Ç–µ—Ä —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Gemini. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–∞–Ω–∞–ª–æ–≤ –∏ —Ç–æ–ø–∏–∫–æ–≤, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç channel_id.
- `scripts/ollama_supa_json.py` ‚Äî —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∏ (–∑–∞–ø–æ–ª–Ω—è–µ—Ç –ø—É—Å—Ç—ã–µ –ø–æ–ª—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å—è—Ö).
- `!–ü—Ä–æ–º—Ç—ã/unified_ollama_prompt.md` ‚Äî **–≥–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –¥–ª—è AI**.
- `.env` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (API –∫–ª—é—á–∏, URL –±–∞–∑—ã). **–ù–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Git!**
- `deploy.sh` ‚Äî —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –Ω–∞ VPS.

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤
–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ª–æ–≥–∏–∫–µ —Ä–∞–±–æ—Ç—ã –ò–ò –¥–æ–ª–∂–Ω—ã –≤–Ω–æ—Å–∏—Ç—å—Å—è –≤ —Ñ–∞–π–ª `!–ü—Ä–æ–º—Ç—ã/unified_ollama_prompt.md`. 
**–í–∞–∂–Ω–æ:** 
- –ü—Ä–æ–º–ø—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç **—á–∏—Å—Ç–æ–≥–æ JSON**.
- –ì–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî **2026**.
- –ü–æ–ª–µ `is_event` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –±—É–¥–µ—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ.
- –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞—Ç—ã ("—Å–µ–≥–æ–¥–Ω—è", "–ø—è—Ç–Ω–∏—Ü–∞") —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç –¥–∞—Ç—ã –ø–æ—Å—Ç–∞.

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–Ω–∞–ª–æ–≤ (channel_sync_state)
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ `channel_sync_state` –∫—Ä–∞–π–Ω–µ –≤–∞–∂–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–ø–æ–ª–Ω—è—Ç—å –ø–æ–ª—è:

- **channel_id**: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —á–∏—Å–ª–æ–≤–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä. 
    - **–í–∞–∂–Ω–æ:** –î–ª—è –∫–∞–Ω–∞–ª–æ–≤ –∏ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø –æ–Ω –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å `-100` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `-1001699038315`).
    - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–æ–≤–æ–≥–æ ID –≤–º–µ—Å—Ç–æ `@username` –¥–µ–ª–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞–º–Ω–æ–≥–æ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–º–µ–Ω—ã –∏–º–µ–Ω–∏ –∫–∞–Ω–∞–ª–∞).
    - **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ï—Å–ª–∏ `channel_id` –Ω–µ —É–∫–∞–∑–∞–Ω, —Å–∫—Ä–∏–ø—Ç –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –µ–≥–æ –ø–æ `channel_name`.
- **channel_name**: –Æ–∑–µ—Ä–Ω–µ–π–º –∫–∞–Ω–∞–ª–∞ —Å —Å–∏–º–≤–æ–ª–æ–º `@`. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç (fallback), –µ—Å–ª–∏ ID –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.
- **thread_id**: ID –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–µ–º—ã (—Ç–æ–ø–∏–∫–∞), –µ—Å–ª–∏ –∫–∞–Ω–∞–ª —è–≤–ª—è–µ—Ç—Å—è —Ñ–æ—Ä—É–º–æ–º. –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞.

## –ö–∞–∫ —É–∑–Ω–∞—Ç—å ID –∫–∞–Ω–∞–ª–∞
–í –ø–∞–ø–∫–µ `scripts/` –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç `get_channel_id.py`. 
–ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –µ–≥–æ –∏ –≤–≤–µ–¥–∏—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º –∫–∞–Ω–∞–ª–∞:
```bash
source venv/bin/activate
python3 scripts/get_channel_id.py
```

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Python 3.10+
- Telethon, httpx, google-generativeai
- Supabase –ø—Ä–æ–µ–∫—Ç —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ `posts` –∏ `channel_sync_state`.
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: `TELEGRAM_API_ID`, `TELEGRAM_API_HASH`, `TELEGRAM_SESSION`, `MY_SUPABASE_URL`, `MY_SUPABASE_SERVICE_ROLE_KEY`, `GEMINI_API_KEY`.
